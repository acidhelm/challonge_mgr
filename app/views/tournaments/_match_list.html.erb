<% show_actions = !(matches.all?(&:complete?) || matches.all?(&:teams_are_tbd?) || matches.any?(&:current_match?)) %>
<table>
  <tr>
    <th>Match #</th>
    <th>Round</th>
    <th>Teams</th>
    <% if show_actions %>
      <th>Actions</th>
    <% end %>
  </tr>
  <% matches.each do |m| %>
  <% if m.get_team_id(:left)
         left_team_name = m.team_name(:left)

         if m.complete?
             left_team_class = m.team_won?(:left) ? "winning_team" : "losing_team"
         else
             left_team_class = "upcoming_team"
         end
     else
         winner_or_loser = m.left_team_is_prereq_match_loser? ? "Loser" : "Winner"
         match_num = m.tournament.matches.find_by_challonge_id(m.left_team_prereq_match_id).number
         left_team_name = "#{winner_or_loser} of match #{match_num}"
         left_team_class = "tbd_team"
     end
  %>
  <% if m.get_team_id(:right)
         right_team_name = m.team_name(:right)

         if m.complete?
             right_team_class = m.team_won?(:right) ? "winning_team" : "losing_team"
         else
             right_team_class = "upcoming_team"
         end
     else
         winner_or_loser = m.right_team_is_prereq_match_loser? ? "Loser" : "Winner"
         match_num = m.tournament.matches.find_by_challonge_id(m.right_team_prereq_match_id).number
         right_team_name = "#{winner_or_loser} of match #{match_num}"
         right_team_class = "tbd_team"
     end
  %>
  <tr>
    <td><%= m.number %></td>
    <td><%= m.round_name %></td>
    <td>
      <% if m.complete? %>
        <span class="<%= left_team_class %>"><%= "#{left_team_name}&nbsp;&nbsp;#{m.left_team_score}".html_safe %></span> &mdash;
        <span class="<%= right_team_class %>"><%= "#{m.right_team_score}&nbsp;&nbsp;#{right_team_name}".html_safe %></span>
      <% else %>
        <span class="<%= left_team_class %>"><%= left_team_name %></span> &mdash;
        <span class="<%= right_team_class %>"><%= right_team_name %></span>
      <% end %>
    </td>
    <% if !(m.complete? || m.teams_are_tbd? || m.current_match?) %>
      <td>
        <%= link_to "Start this match", [ :start, @user, @tournament, m ], method: :post %>
      </td>
    <% end %>
  </tr>
  <% end %>
</table>
